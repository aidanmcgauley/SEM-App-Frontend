<!DOCTYPE html>
<html>
<head>
<title>StudentEngagementMonitoring</title>

<script type="text/javascript">

let maxminURL = "http://sem-maxmin-40058902.40058902.qpc.hal.davecutting.uk/";
let sortedURL = "http://localhost:8002/";
let totalHoursURL = "http://sem-totalhours-40058902.40058902.qpc.hal.davecutting.uk/";
let engagementScoreURL = "http://localhost:8004/";
let riskFailureURL = "http://localhost:8005/";
let sortedByPercentageURL = "https://us-east1-radiant-destiny-392018.cloudfunctions.net/sortbypercentage";

//let maxminURL = "http://semmaxmin.esha.qpc.hal.davecutting.uk/";
//let sortedURL = "http://semsort.esha.qpc.hal.davecutting.uk/";

function displayTotal(total_attendance)
{
    document.getElementById('output-text').value = 'Total Attendance (in hours) = ' + total_attendance + ' hours';

}

function displayMaxMin(max_attendance_items, min_attendance_items) {
    let max_text = 'Maximum attendance(s) = ';
    let min_text = 'Minimum attendance(s) = ';

    // Handling multiple maximum attendance items
    max_attendance_items.forEach((item, index) => {
        max_text += item + ' hours';
        if (index < max_attendance_items.length - 1) max_text += ', ';
    });

    // Handling multiple minimum attendance items
    min_attendance_items.forEach((item, index) => {
        min_text += item + ' hours';
        if (index < min_attendance_items.length - 1) min_text += ', ';
    });

    document.getElementById('output-text').value = max_text + '\n' + min_text;
}

function displaySortedAttendance(sorted_attendance)
{
    document.getElementById('output-text').value = sorted_attendance;

}

function displayStudentEngagementScore(student_engagement_score)
{
    document.getElementById('output-text').value = 'Student Engagement Score = ' + student_engagement_score + '%.';
}

function displayRisk(risk_of_failure, engagement_score, cut_off_score)
{
    document.getElementById('output-text').value = 'You are ' + risk_of_failure + 
    ' of failing.\nYour engagement score is currently ' + engagement_score + '%.'
    + '\nThe cut-off engagement score is ' + cut_off_score + '%.';
}

function displaySortedByPercentage(sorted_by_percentage) {
    var outputText = '';
    outputText += "Attendance sorted from highest to lowest percentage of total hours:\n\n"
    for (var i = 0; i < sorted_by_percentage.length; i++) {
        outputText += "Item: " + sorted_by_percentage[i]['item'] + "\n" 
                      + "Attendance: " + sorted_by_percentage[i]['attendance'] + "\n" 
                      + "Total hours: " + sorted_by_percentage[i]['total_hours'] + "\n"
                      + "Percentage: " + sorted_by_percentage[i]['percentage'].toFixed(2) + "%\n\n";
    }

    document.getElementById('output-text').value = outputText;
}

function clearText()
{
    document.getElementById('attendance_1').value = '';
    document.getElementById('attendance_2').value = '';
    document.getElementById('attendance_3').value = '';
    document.getElementById('attendance_4').value = '';
    document.getElementById('output-text').value = '';
}

function getSortedByPercentage() 
{
    let item_1 = document.getElementById('item_1').value;
    let item_2 = document.getElementById('item_2').value;
    let item_3 = document.getElementById('item_3').value;
    let item_4 = document.getElementById('item_4').value;

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let attendance_1 = document.getElementById('attendance_1').value;
    let attendance_2 = document.getElementById('attendance_2').value;
    let attendance_3 = document.getElementById('attendance_3').value;
    let attendance_4 = document.getElementById('attendance_4').value;

    let xhttp = new XMLHttpRequest();

    xhttp.onload = function () {
        if (xhttp.status >= 200 && xhttp.status < 300) {
            // Handle success here
            var j = JSON.parse(this.response);
            console.log("Server response:", this.response);
            if (j.error) {
                    alert(j.message); // Show the error message as an alert
                } else {
                    let sorted_by_percentage = j.sorted_by_percentage;
                    displaySortedByPercentage(sorted_by_percentage);
                }
            
        } else if (xhttp.status >= 400 && xhttp.status < 500) {
            // Client errors
            alert('There was a problem with the request. Please check your input and try again.');
        } else if (xhttp.status >= 500) {
            // Server errors
            alert('The server encountered a problem. Please try again later.');
        }
    };

    xhttp.onerror = function() {
        alert('Request failed due to a network error.');
    };
    xhttp.ontimeout = function() {
        alert('Request timed out.');
    };

    xhttp.open("GET", sortedByPercentageURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&total_hours_1=" + total_hours_1
        + "&item_2=" + item_2 + "&attendance_2=" + attendance_2 + "&total_hours_2=" + total_hours_2
        + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&total_hours_3=" + total_hours_3
        + "&item_4=" + item_4 + "&attendance_4=" + attendance_4 + "&total_hours_4=" + total_hours_4);
    xhttp.send();
    return;
}


function getRisk()
{
    let item_1 = document.getElementById('item_1').value;
    let item_2 = document.getElementById('item_2').value;
    let item_3 = document.getElementById('item_3').value;
    let item_4 = document.getElementById('item_4').value;

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let attendance_1 = document.getElementById('attendance_1').value;
    let attendance_2 = document.getElementById('attendance_2').value;
    let attendance_3 = document.getElementById('attendance_3').value;
    let attendance_4 = document.getElementById('attendance_4').value;
    let cut_off_score = document.getElementById('cut-off').value;

    // first, get the engagement score
    let xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        if (xhttp.status >= 200 && xhttp.status < 300) {
            let j = JSON.parse(xhttp.response);
            if (j.error) {
                alert(j.message); // Show the specific error message from the Java backend
                return; // Do not proceed with the second request
            }
            let engagement_score = j.engagement_score;

            // now that we have the engagement score, call getRisk
            let xhttp2 = new XMLHttpRequest();
            xhttp2.onload = function() {
                if (xhttp2.status >= 200 && xhttp2.status < 300) {
                    let j2 = JSON.parse(xhttp2.response);
                    if (j2.error) {
                        alert(j2.error); // Show the specific error message from the server
                    } else {
                        let risk = j2.risk;
                        let engagement_score = j2.engagement_score;
                        let cut_off_score = j2.cut_off_score;
                        displayRisk(risk, engagement_score, cut_off_score);
                    }
                    
                } else if (xhttp2.status === 400) {
                    // Handle 400 status code
                    let j2 = JSON.parse(xhttp2.response);
                    if (j2.error) {
                        alert(j2.error); // Show the specific error message from the server
                    } else {
                        alert('Unknown error occurred. Please try again.');
                    }
                } else if (xhttp2.status >= 500) {
                    alert('The server encountered a problem. Please try again later.');
                }
            };
            xhttp2.onerror = function() {
                alert('Request failed due to a network error.');
            };
            xhttp2.ontimeout = function() {
                alert('Request timed out.');
            };
            xhttp2.open("GET", riskFailureURL + "?engagement_score=" + engagement_score + "&cut_off_score=" + cut_off_score);
            xhttp2.send();

        } else if (xhttp.status >= 400 && xhttp.status < 500) {
            alert('There was a problem with the request. Please check your input and try again.');
        } else if (xhttp.status >= 500) {
            alert('The server encountered a problem. Please try again later.');
        }
    };

    xhttp.onerror = function() {
        alert('Request failed due to a network error.');
    };
    xhttp.ontimeout = function() {
        alert('Request timed out.');
    };

    xhttp.open("GET", engagementScoreURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&total_hours_1=" + total_hours_1
        + "&item_2=" + item_2 + "&attendance_2=" + attendance_2 + "&total_hours_2=" + total_hours_2
        + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&total_hours_3=" + total_hours_3
        + "&item_4=" + item_4 + "&attendance_4=" + attendance_4 + "&total_hours_4=" + total_hours_4);
    xhttp.send();
    return;
}


function getEngagementScore()
{
    let item_1 = document.getElementById('item_1').value;
    let item_2 = document.getElementById('item_2').value;
    let item_3 = document.getElementById('item_3').value;
    let item_4 = document.getElementById('item_4').value;

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let attendance_1 = document.getElementById('attendance_1').value;
    let attendance_2 = document.getElementById('attendance_2').value;
    let attendance_3 = document.getElementById('attendance_3').value;
    let attendance_4 = document.getElementById('attendance_4').value;

    let xhttp = new XMLHttpRequest();
    
        xhttp.onload = function () {
            if (xhttp.status >= 200 && xhttp.status < 300) {
                // Handle success here
                var j = JSON.parse(this.response);
                if (j.error) {
                    alert(j.message); // Show the error message as an alert
                } else {
                    let student_engagement_score = j.engagement_score;
                    displayStudentEngagementScore(student_engagement_score);
                }
            } else if (xhttp.status >= 400 && xhttp.status < 500) {
                // Client errors
                console.log('There was a problem with the request. Please check your input and try again.');
            } else if (xhttp.status >= 500) {
                // Server errors
                console.log('The server encountered a problem. Please try again later.');
            }
        };

        xhttp.onerror = function() {
            console.log('Request failed due to a network error.');
        };

        xhttp.ontimeout = function() {
            console.log('Request timed out.');
        };

        xhttp.open("GET", engagementScoreURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&total_hours_1=" + total_hours_1
        + "&item_2=" + item_2 + "&attendance_2=" + attendance_2 + "&total_hours_2=" + total_hours_2
        + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&total_hours_3=" + total_hours_3
        + "&item_4=" + item_4 + "&attendance_4=" + attendance_4 + "&total_hours_4=" + total_hours_4);
        xhttp.send();
        return;
}

function getMaxMin()
{
    let item_1 = document.getElementById('item_1').value
    let item_2 = document.getElementById('item_2').value
    let item_3 = document.getElementById('item_3').value
    let item_4 = document.getElementById('item_4').value

    let attendance_1 = document.getElementById('attendance_1').value
    let attendance_2 = document.getElementById('attendance_2').value
    let attendance_3 = document.getElementById('attendance_3').value
    let attendance_4 = document.getElementById('attendance_4').value

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let xhttp = new XMLHttpRequest();

    xhttp.onload = function() {
        if (xhttp.status >= 200 && xhttp.status < 300) {
            var j = JSON.parse(this.response);
            if (j.error) {
                alert(j.message); // Show the error message as an alert
            } else {
                let max_attendance_items = j.max_items;
                let min_attendance_items = j.min_items;
                displayMaxMin(max_attendance_items, min_attendance_items);
            }

        // These checks are not strictly necessary since I'm always returning 200 along with boolean error from php backend services
        // It may be more useful to handle errors in this way if I wasn't in control of the backend
        } else if (xhttp.status >= 400 && xhttp.status < 500) {
            // Client errors
            console.log('There was a problem with the request. Please check your input and try again.');
        } else if (xhttp.status >= 500) {
            // Server errors
            console.log('The server encountered a problem. Please try again later.');
        }
    };

    xhttp.onerror = function() {
        console.log('Request failed due to a network error.');
    };

    xhttp.ontimeout = function() {
        console.log('Request timed out.');
    };

    xhttp.open("GET",maxminURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&item_2=" + item_2 + "&attendance_2=" + attendance_2
    + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&item_4=" + item_4 + "&attendance_4=" + attendance_4
    + "&total_hours_1=" + total_hours_1 + "&total_hours_2=" + total_hours_2 + "&total_hours_3=" + total_hours_3 + "&total_hours_4=" + total_hours_4);
    xhttp.send();
    return;
}

function getSortedAttendance()
{
    let item_1 = document.getElementById('item_1').value
    let item_2 = document.getElementById('item_2').value
    let item_3 = document.getElementById('item_3').value
    let item_4 = document.getElementById('item_4').value

    let attendance_1 = document.getElementById('attendance_1').value
    let attendance_2 = document.getElementById('attendance_2').value
    let attendance_3 = document.getElementById('attendance_3').value
    let attendance_4 = document.getElementById('attendance_4').value

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        if (xhttp.status >= 200 && xhttp.status < 300) {
            var j = JSON.parse(this.response);
            if (j.error) {
                alert(j.message); // Show the error message as an alert
            } else {
                let sorted_attendance_returned = j.sorted_attendance;
                let sorted_attendance = 'Attendance sorted from highest to lowest:\r\n';
                for (let i = 0; i < sorted_attendance_returned.length; i++) {
                    sorted_attendance += sorted_attendance_returned[i]['item'] + ' - ' + sorted_attendance_returned[i]['attendance'] + ' hours' + '\r\n';
                }
                displaySortedAttendance(sorted_attendance);
            }
        // These checks are not strictly necessary since I'm always returning 200 along with boolean error from php backend services
        // It may be more useful to handle errors in this way if I wasn't in control of the backend
        }else if (xhttp.status >= 400 && xhttp.status < 500) {
            // Client errors
            console.log('There was a problem with the request. Please check your input and try again.');
        } else if (xhttp.status >= 500) {
            // Server errors
            console.log('The server encountered a problem. Please try again later.');
        }

    };

    xhttp.onerror = function() {
        console.log('Request failed due to a network error.');
    };
    xhttp.ontimeout = function() {
        console.log('Request timed out.');
    };

    xhttp.open("GET",sortedURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&item_2=" + item_2 + "&attendance_2=" + attendance_2
    + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&item_4=" + item_4 + "&attendance_4=" + attendance_4
    + "&total_hours_1=" + total_hours_1 + "&total_hours_2=" + total_hours_2 + "&total_hours_3=" + total_hours_3 + "&total_hours_4=" + total_hours_4);
    xhttp.send();
    return;
}

function getTotal()
{
    let item_1 = document.getElementById('item_1').value
    let item_2 = document.getElementById('item_2').value
    let item_3 = document.getElementById('item_3').value
    let item_4 = document.getElementById('item_4').value

    let attendance_1 = document.getElementById('attendance_1').value
    let attendance_2 = document.getElementById('attendance_2').value
    let attendance_3 = document.getElementById('attendance_3').value
    let attendance_4 = document.getElementById('attendance_4').value

    let total_hours_1 = document.getElementById('hours_1').innerText.split(' ')[0].slice(1);
    let total_hours_2 = document.getElementById('hours_2').innerText.split(' ')[0].slice(1);
    let total_hours_3 = document.getElementById('hours_3').innerText.split(' ')[0].slice(1);
    let total_hours_4 = document.getElementById('hours_4').innerText.split(' ')[0].slice(1);

    let xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
        if (xhttp.status >= 200 && xhttp.status < 300) {
            var j = JSON.parse(this.response);
            if (j.error) {
                alert(j.message); // Show the error message as an alert
            } else {
                let total_attendance = j.total_hours;
                displayTotal(total_attendance);
            }
        }else if (xhttp.status >= 400 && xhttp.status < 500) {
            // Client errors
            var j = JSON.parse(this.response); // Parse the response
            alert(j.message); // Show the error message as an alert
        } else if (xhttp.status >= 500) {
            // Server errors
            console.log('The server encountered a problem. Please try again later.');
        }
    };

    xhttp.onerror = function() {
        console.log('Request failed due to a network error.');
    };
    xhttp.ontimeout = function() {
        console.log('Request timed out.');
    };

    xhttp.open("GET",totalHoursURL+"?item_1=" + item_1 + "&attendance_1=" + attendance_1 + "&item_2=" + item_2 + "&attendance_2=" + attendance_2
    + "&item_3=" + item_3 + "&attendance_3=" + attendance_3 + "&item_4=" + item_4 + "&attendance_4=" + attendance_4
    + "&total_hours_1=" + total_hours_1 + "&total_hours_2=" + total_hours_2 + "&total_hours_3=" + total_hours_3 + "&total_hours_4=" + total_hours_4);
    xhttp.send();
    return;
}


</script>

<style type="text/css">
body  {
    font-size: 150%;
    font-family: monospace;
}
label {
    display: inline-block;
    width: 150px;
    text-align: left;
}
#logo
{
    font-family: Calibri, sans-serif;
    font-weight: lighter;
    color: #505050;
    margin: 0.5em;
}

#sem
{
    text-align: center;
    margin-top: 1em;
}
#input-div-1
{
    text-align: center;
    margin-top: 1em;
    background-color:#d5d8dc  ;
}
#input-div-2
{
    text-align: center;
    background-color:#abb2b9 ;
}
#output-div
{
    text-align: center;
    background-color:#808b96 ;
}
.display-item {
    font-size: 90%;
    color: black;
    font-family: monospace;
    background-color: white;
    padding: 0.2em;
    margin: 0.2em;
    letter-spacing: 0.1em;
    width: 380px;
    text-align: right;
}

.display-attendance{
    font-size: 90%;
    color: black;
    background-color: white;
    padding: 0.2em;
    margin: 0.2em;
    font-family: monospace;
    letter-spacing: 0.1em;
    width: 40px;
}

.display-output {
    font-size: 90%;
    color: black;
    background-color:white ;
    padding: 0.2em;
    margin: 0.2em;
    font-family: monospace;
    letter-spacing: 0.1em;
    width: 600px;

}

.sembutton-active {
    background-color:   #2874a6  ;
    color: white;
    padding: 0px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 18px;
    margin: 4px 2px;
    cursor: pointer;
    height: 50px;
    width: 400px;
}

.sembutton-inactive {
    background-color: gray;
    color: white;
    padding: 0px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 18px;
    margin: 4px 2px;
    cursor: pointer;
    height: 50px;
    width: 400px;
}

.sembutton-clear {
    background-color:  #c0392b ;
    color: white;
    padding: 0px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 18px;
    margin: 4px 2px;
    cursor: pointer;
    height: 40px;
    width: 400px;
}

</style>

</head>
<body>
<div id="sem">
    <div id="logo">
        Student Engaggement Monitoring
    </div>
    <div id="input-div-1">
    <div>
        <input class="display-item" type="text" id="item_1" name="item_1" value="Lecture sessions">
        <input class="display-attendance"  type="text" id="attendance_1" name="attendance_1" placeholder="00"><label id="hours_1">/33 (hours)</label>
    </div>
    <div>
        <input class="display-item" type="text" id="item_2" name="item_2" value="Lab sessions">
        <input class="display-attendance"  type="text" id="attendance_2" name="attendance_2" placeholder="00"><label id="hours_2">/22 (hours)</label>
    </div>
    <div>
        <input class="display-item" type="text" id="item_3" name="item_3" value="Support sessions">
        <input class="display-attendance"  type="text" id="attendance_3" name="attendance_3" placeholder="00"><label id="hours_3">/44 (hours)</label>
    </div>
    <div>
        <input class="display-item" type="text" id="item_4" name="item_4" value="Canvas activities">
        <input class="display-attendance"  type="text" id="attendance_4" name="attendance_4" placeholder="00"><label id="hours_4">/55 (hours)</label>
    </div>
    </div>
    <div id="input-div-2">
        <label class="display-item" id="cutoff">Cut-off Engagement Score</label>
        <input class="display-attendance"  type="text" id="cut-off" name="cut-off" placeholder="00"><label>/100 (%)</label>
    </div>
    <div id="output-div">
        <textarea class="display-output" id="output-text" rows="5" cols="35" readonly=1 placeholder="Results here..." value="">
        </textarea>
    </div>
    <div>
        <button class="sembutton-active" onclick="getMaxMin();">Maximum and Minimum Attendance</button>
    </div>
    <div>
        <button class="sembutton-active" onclick="getSortedAttendance();">Sort Attendance</button>
    </div>
    <div>
        <button class="sembutton-active" onclick="getTotal();">Total Attendance Hours</button>
    </div>
    <div>
        <button class="sembutton-active" onclick="getEngagementScore();">Student Engagement Score</button>
    </div>
    <div>
        <button class="sembutton-active" onclick="getRisk();">Risk of Student Failure</button>
    </div>
    <div>
        <button class="sembutton-active" onclick="getSortedByPercentage();">Sort Attendance by %</button>
    </div>
    <div>
        <button class="sembutton-clear" onclick="clearText();">Clear</button>
    </div>

</div>

</body>

<script type="text/javascript">

</script>

</html>
